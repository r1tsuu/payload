{"version":3,"sources":["../../../src/auth/operations/auth.ts"],"sourcesContent":["import type { TypedUser } from '../../index.js'\nimport type { PayloadRequestWithData } from '../../types/index.js'\nimport type { Permissions } from '../types.js'\n\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { executeAuthStrategies } from '../executeAuthStrategies.js'\nimport { getAccessResults } from '../getAccessResults.js'\n\nexport type AuthArgs = {\n  headers: Request['headers']\n  req?: Omit<PayloadRequestWithData, 'user'>\n}\n\nexport type AuthResult = {\n  permissions: Permissions\n  responseHeaders?: Headers\n  user: TypedUser | null\n}\n\nexport const auth = async (args: Required<AuthArgs>): Promise<AuthResult> => {\n  const { headers } = args\n  const req = args.req as PayloadRequestWithData\n  const { payload } = req\n\n  try {\n    const shouldCommit = await initTransaction(req)\n\n    const { responseHeaders, user } = await executeAuthStrategies({\n      headers,\n      payload,\n    })\n\n    req.user = user\n    req.responseHeaders = responseHeaders\n\n    const permissions = await getAccessResults({\n      req,\n    })\n\n    if (shouldCommit) await commitTransaction(req)\n\n    return {\n      permissions,\n      responseHeaders,\n      user,\n    }\n  } catch (error: unknown) {\n    await killTransaction(req)\n    throw error\n  }\n}\n"],"names":["commitTransaction","initTransaction","killTransaction","executeAuthStrategies","getAccessResults","auth","args","headers","req","payload","shouldCommit","responseHeaders","user","permissions","error"],"mappings":"AAIA,SAASA,iBAAiB,QAAQ,uCAAsC;AACxE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,qBAAqB,QAAQ,8BAA6B;AACnE,SAASC,gBAAgB,QAAQ,yBAAwB;AAazD,OAAO,MAAMC,OAAO,OAAOC;IACzB,MAAM,EAAEC,OAAO,EAAE,GAAGD;IACpB,MAAME,MAAMF,KAAKE,GAAG;IACpB,MAAM,EAAEC,OAAO,EAAE,GAAGD;IAEpB,IAAI;QACF,MAAME,eAAe,MAAMT,gBAAgBO;QAE3C,MAAM,EAAEG,eAAe,EAAEC,IAAI,EAAE,GAAG,MAAMT,sBAAsB;YAC5DI;YACAE;QACF;QAEAD,IAAII,IAAI,GAAGA;QACXJ,IAAIG,eAAe,GAAGA;QAEtB,MAAME,cAAc,MAAMT,iBAAiB;YACzCI;QACF;QAEA,IAAIE,cAAc,MAAMV,kBAAkBQ;QAE1C,OAAO;YACLK;YACAF;YACAC;QACF;IACF,EAAE,OAAOE,OAAgB;QACvB,MAAMZ,gBAAgBM;QACtB,MAAMM;IACR;AACF,EAAC"}