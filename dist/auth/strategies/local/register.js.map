{"version":3,"sources":["../../../../src/auth/strategies/local/register.ts"],"sourcesContent":["import type { SanitizedCollectionConfig } from '../../../collections/config/types.js'\nimport type { Payload } from '../../../index.js'\nimport type { PayloadRequestWithData } from '../../../types/index.js'\n\nimport { ValidationError } from '../../../errors/index.js'\nimport { generatePasswordSaltHash } from './generatePasswordSaltHash.js'\n\ntype Args = {\n  collection: SanitizedCollectionConfig\n  doc: Record<string, unknown>\n  password: string\n  payload: Payload\n  req: PayloadRequestWithData\n}\n\nexport const registerLocalStrategy = async ({\n  collection,\n  doc,\n  password,\n  payload,\n  req,\n}: Args): Promise<Record<string, unknown>> => {\n  const existingUser = await payload.find({\n    collection: collection.slug,\n    depth: 0,\n    limit: 1,\n    pagination: false,\n    req,\n    where: {\n      email: {\n        equals: doc.email,\n      },\n    },\n  })\n\n  if (existingUser.docs.length > 0) {\n    throw new ValidationError({\n      collection: collection.slug,\n      errors: [{ field: 'email', message: req.t('error:userEmailAlreadyRegistered') }],\n    })\n  }\n\n  const { hash, salt } = await generatePasswordSaltHash({ collection, password })\n\n  const sanitizedDoc = { ...doc }\n  if (sanitizedDoc.password) delete sanitizedDoc.password\n\n  return payload.db.create({\n    collection: collection.slug,\n    data: {\n      ...sanitizedDoc,\n      hash,\n      salt,\n    },\n    req,\n  })\n}\n"],"names":["ValidationError","generatePasswordSaltHash","registerLocalStrategy","collection","doc","password","payload","req","existingUser","find","slug","depth","limit","pagination","where","email","equals","docs","length","errors","field","message","t","hash","salt","sanitizedDoc","db","create","data"],"mappings":"AAIA,SAASA,eAAe,QAAQ,2BAA0B;AAC1D,SAASC,wBAAwB,QAAQ,gCAA+B;AAUxE,OAAO,MAAMC,wBAAwB,OAAO,EAC1CC,UAAU,EACVC,GAAG,EACHC,QAAQ,EACRC,OAAO,EACPC,GAAG,EACE;IACL,MAAMC,eAAe,MAAMF,QAAQG,IAAI,CAAC;QACtCN,YAAYA,WAAWO,IAAI;QAC3BC,OAAO;QACPC,OAAO;QACPC,YAAY;QACZN;QACAO,OAAO;YACLC,OAAO;gBACLC,QAAQZ,IAAIW,KAAK;YACnB;QACF;IACF;IAEA,IAAIP,aAAaS,IAAI,CAACC,MAAM,GAAG,GAAG;QAChC,MAAM,IAAIlB,gBAAgB;YACxBG,YAAYA,WAAWO,IAAI;YAC3BS,QAAQ;gBAAC;oBAAEC,OAAO;oBAASC,SAASd,IAAIe,CAAC,CAAC;gBAAoC;aAAE;QAClF;IACF;IAEA,MAAM,EAAEC,IAAI,EAAEC,IAAI,EAAE,GAAG,MAAMvB,yBAAyB;QAAEE;QAAYE;IAAS;IAE7E,MAAMoB,eAAe;QAAE,GAAGrB,GAAG;IAAC;IAC9B,IAAIqB,aAAapB,QAAQ,EAAE,OAAOoB,aAAapB,QAAQ;IAEvD,OAAOC,QAAQoB,EAAE,CAACC,MAAM,CAAC;QACvBxB,YAAYA,WAAWO,IAAI;QAC3BkB,MAAM;YACJ,GAAGH,YAAY;YACfF;YACAC;QACF;QACAjB;IACF;AACF,EAAC"}