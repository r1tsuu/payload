{"version":3,"sources":["../../src/auth/cookies.ts"],"sourcesContent":["import type { Payload } from '../index.js'\nimport type { SanitizedCollectionConfig } from './../collections/config/types.js'\n\ntype CookieOptions = {\n  domain?: string\n  expires?: Date\n  httpOnly?: boolean\n  maxAge?: number\n  name: string\n  path?: string\n  returnCookieAsObject: boolean\n  sameSite?: 'Lax' | 'None' | 'Strict'\n  secure?: boolean\n  value?: string\n}\n\ntype CookieObject = {\n  domain?: string\n  expires?: string\n  httpOnly?: boolean\n  maxAge?: number\n  name: string\n  path?: string\n  sameSite?: 'Lax' | 'None' | 'Strict'\n  secure?: boolean\n  value: string\n}\n\nexport const generateCookie = <ReturnCookieAsObject = boolean>(\n  args: CookieOptions,\n): ReturnCookieAsObject extends true ? CookieObject : string => {\n  const {\n    name,\n    domain,\n    expires,\n    httpOnly,\n    maxAge,\n    path,\n    returnCookieAsObject,\n    sameSite,\n    secure: secureArg,\n    value,\n  } = args\n\n  let cookieString = `${name}=${value || ''}`\n  const cookieObject: CookieObject = {\n    name,\n    value,\n  }\n\n  const secure = secureArg || sameSite === 'None'\n\n  if (expires) {\n    if (returnCookieAsObject) {\n      cookieObject.expires = expires.toUTCString()\n    } else {\n      cookieString += `; Expires=${expires.toUTCString()}`\n    }\n  }\n\n  if (maxAge) {\n    if (returnCookieAsObject) {\n      cookieObject.maxAge = maxAge\n    } else {\n      cookieString += `; Max-Age=${maxAge.toString()}`\n    }\n  }\n\n  if (domain) {\n    if (returnCookieAsObject) {\n      cookieObject.domain = domain\n    } else {\n      cookieString += `; Domain=${domain}`\n    }\n  }\n\n  if (path) {\n    if (returnCookieAsObject) {\n      cookieObject.path = path\n    } else {\n      cookieString += `; Path=${path}`\n    }\n  }\n\n  if (secure) {\n    if (returnCookieAsObject) {\n      cookieObject.secure = secure\n    } else {\n      cookieString += `; Secure=${secure}`\n    }\n  }\n\n  if (httpOnly) {\n    if (returnCookieAsObject) {\n      cookieObject.httpOnly = httpOnly\n    } else {\n      cookieString += `; HttpOnly=${httpOnly}`\n    }\n  }\n\n  if (sameSite) {\n    if (returnCookieAsObject) {\n      cookieObject.sameSite = sameSite\n    } else {\n      cookieString += `; SameSite=${sameSite}`\n    }\n  }\n\n  return (returnCookieAsObject ? cookieObject : cookieString) as ReturnCookieAsObject extends true\n    ? CookieObject\n    : string\n}\ntype GetCookieExpirationArgs = {\n  /*\n    The number of seconds until the cookie expires\n    @default 7200 seconds (2 hours)\n  */\n  seconds: number\n}\nexport const getCookieExpiration = ({ seconds = 7200 }: GetCookieExpirationArgs) => {\n  const currentTime = new Date()\n  currentTime.setSeconds(currentTime.getSeconds() + seconds)\n  return currentTime\n}\n\ntype GeneratePayloadCookieArgs = {\n  /* The auth collection config */\n  collectionConfig: SanitizedCollectionConfig\n  /* An instance of payload */\n  payload: Payload\n  /* The returnAs value */\n  returnCookieAsObject?: boolean\n  /* The token to be stored in the cookie */\n  token: string\n}\nexport const generatePayloadCookie = <T extends GeneratePayloadCookieArgs>({\n  collectionConfig,\n  payload,\n  returnCookieAsObject = false,\n  token,\n}: T): T['returnCookieAsObject'] extends true ? CookieObject : string => {\n  const sameSite =\n    typeof collectionConfig.auth.cookies.sameSite === 'string'\n      ? collectionConfig.auth.cookies.sameSite\n      : collectionConfig.auth.cookies.sameSite\n        ? 'Strict'\n        : undefined\n\n  return generateCookie<T['returnCookieAsObject']>({\n    name: `${payload.config.cookiePrefix}-token`,\n    domain: collectionConfig.auth.cookies.domain ?? undefined,\n    expires: getCookieExpiration({ seconds: collectionConfig.auth.tokenExpiration }),\n    httpOnly: true,\n    path: '/',\n    returnCookieAsObject,\n    sameSite,\n    secure: collectionConfig.auth.cookies.secure,\n    value: token,\n  })\n}\n\nexport const generateExpiredPayloadCookie = <T extends Omit<GeneratePayloadCookieArgs, 'token'>>({\n  collectionConfig,\n  payload,\n  returnCookieAsObject = false,\n}: T): T['returnCookieAsObject'] extends true ? CookieObject : string => {\n  const sameSite =\n    typeof collectionConfig.auth.cookies.sameSite === 'string'\n      ? collectionConfig.auth.cookies.sameSite\n      : collectionConfig.auth.cookies.sameSite\n        ? 'Strict'\n        : undefined\n\n  const expires = new Date(Date.now() - 1000)\n\n  return generateCookie<T['returnCookieAsObject']>({\n    name: `${payload.config.cookiePrefix}-token`,\n    domain: collectionConfig.auth.cookies.domain ?? undefined,\n    expires,\n    httpOnly: true,\n    path: '/',\n    returnCookieAsObject,\n    sameSite,\n    secure: collectionConfig.auth.cookies.secure,\n  })\n}\n\nexport const parseCookies = (headers: Request['headers']): Map<string, string> => {\n  const cookieMap = new Map<string, string>()\n  const cookie = headers.get('Cookie')\n\n  if (cookie) {\n    cookie.split(';').forEach((cookie) => {\n      const parts = cookie.split('=')\n      const key = parts.shift().trim()\n      const encodedValue = parts.join('=')\n\n      try {\n        const decodedValue = decodeURI(encodedValue)\n        cookieMap.set(key, decodedValue)\n      } catch (e) {\n        return null\n      }\n    })\n  }\n\n  return cookieMap\n}\n"],"names":["generateCookie","args","name","domain","expires","httpOnly","maxAge","path","returnCookieAsObject","sameSite","secure","secureArg","value","cookieString","cookieObject","toUTCString","toString","getCookieExpiration","seconds","currentTime","Date","setSeconds","getSeconds","generatePayloadCookie","collectionConfig","payload","token","auth","cookies","undefined","config","cookiePrefix","tokenExpiration","generateExpiredPayloadCookie","now","parseCookies","headers","cookieMap","Map","cookie","get","split","forEach","parts","key","shift","trim","encodedValue","join","decodedValue","decodeURI","set","e"],"mappings":"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"}