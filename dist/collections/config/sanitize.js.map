{"version":3,"sources":["../../../src/collections/config/sanitize.ts"],"sourcesContent":["import merge from 'deepmerge'\n\nimport type { Config, SanitizedConfig } from '../../config/types.js'\nimport type { CollectionConfig, SanitizedCollectionConfig } from './types.js'\n\nimport baseAccountLockFields from '../../auth/baseFields/accountLock.js'\nimport baseAPIKeyFields from '../../auth/baseFields/apiKey.js'\nimport baseAuthFields from '../../auth/baseFields/auth.js'\nimport baseVerificationFields from '../../auth/baseFields/verification.js'\nimport { TimestampsRequired } from '../../errors/TimestampsRequired.js'\nimport { sanitizeFields } from '../../fields/config/sanitize.js'\nimport { fieldAffectsData } from '../../fields/config/types.js'\nimport mergeBaseFields from '../../fields/mergeBaseFields.js'\nimport { getBaseUploadFields } from '../../uploads/getBaseFields.js'\nimport { formatLabels } from '../../utilities/formatLabels.js'\nimport { isPlainObject } from '../../utilities/isPlainObject.js'\nimport baseVersionFields from '../../versions/baseFields.js'\nimport { versionDefaults } from '../../versions/defaults.js'\nimport { authDefaults, defaults } from './defaults.js'\n\nexport const sanitizeCollection = async (\n  config: Config,\n  collection: CollectionConfig,\n  /**\n   * If this property is set, RichText fields won't be sanitized immediately. Instead, they will be added to this array as promises\n   * so that you can sanitize them together, after the config has been sanitized.\n   */\n  richTextSanitizationPromises?: Array<(config: SanitizedConfig) => Promise<void>>,\n): Promise<SanitizedCollectionConfig> => {\n  // /////////////////////////////////\n  // Make copy of collection config\n  // /////////////////////////////////\n\n  const sanitized: CollectionConfig = merge(defaults, collection, {\n    isMergeableObject: isPlainObject,\n  })\n\n  if (sanitized.timestamps !== false) {\n    // add default timestamps fields only as needed\n    let hasUpdatedAt = null\n    let hasCreatedAt = null\n    sanitized.fields.some((field) => {\n      if (fieldAffectsData(field)) {\n        if (field.name === 'updatedAt') hasUpdatedAt = true\n        if (field.name === 'createdAt') hasCreatedAt = true\n      }\n      return hasCreatedAt && hasUpdatedAt\n    })\n    if (!hasUpdatedAt) {\n      sanitized.fields.push({\n        name: 'updatedAt',\n        type: 'date',\n        admin: {\n          disableBulkEdit: true,\n          hidden: true,\n        },\n        label: ({ t }) => t('general:updatedAt'),\n      })\n    }\n    if (!hasCreatedAt) {\n      sanitized.fields.push({\n        name: 'createdAt',\n        admin: {\n          disableBulkEdit: true,\n          hidden: true,\n        },\n        // The default sort for list view is createdAt. Thus, enabling indexing by default, is a major performance improvement, especially for large or a large amount of collections.\n        type: 'date',\n        index: true,\n        label: ({ t }) => t('general:createdAt'),\n      })\n    }\n  }\n\n  sanitized.labels = sanitized.labels || formatLabels(sanitized.slug)\n\n  if (sanitized.versions) {\n    if (sanitized.versions === true) sanitized.versions = { drafts: false }\n\n    if (sanitized.timestamps === false) {\n      throw new TimestampsRequired(collection)\n    }\n\n    if (sanitized.versions.drafts) {\n      if (sanitized.versions.drafts === true) {\n        sanitized.versions.drafts = {\n          autosave: false,\n          validate: false,\n        }\n      }\n\n      if (sanitized.versions.drafts.autosave === true) {\n        sanitized.versions.drafts.autosave = {\n          interval: versionDefaults.autosaveInterval,\n        }\n      }\n\n      if (sanitized.versions.drafts.validate === undefined) {\n        sanitized.versions.drafts.validate = false\n      }\n\n      sanitized.fields = mergeBaseFields(sanitized.fields, baseVersionFields)\n    }\n  }\n\n  if (sanitized.upload) {\n    if (sanitized.upload === true) sanitized.upload = {}\n\n    // disable duplicate for uploads by default\n    sanitized.disableDuplicate = sanitized.disableDuplicate || true\n\n    sanitized.upload.staticDir = sanitized.upload.staticDir || sanitized.slug\n    sanitized.admin.useAsTitle =\n      sanitized.admin.useAsTitle && sanitized.admin.useAsTitle !== 'id'\n        ? sanitized.admin.useAsTitle\n        : 'filename'\n\n    const uploadFields = getBaseUploadFields({\n      collection: sanitized,\n      config,\n    })\n\n    sanitized.fields = mergeBaseFields(sanitized.fields, uploadFields)\n  }\n\n  if (sanitized.auth) {\n    sanitized.auth = merge(authDefaults, typeof sanitized.auth === 'object' ? sanitized.auth : {}, {\n      isMergeableObject: isPlainObject,\n    })\n\n    let authFields = []\n\n    if (sanitized.auth.useAPIKey) {\n      authFields = authFields.concat(baseAPIKeyFields)\n    }\n\n    if (!sanitized.auth.disableLocalStrategy) {\n      authFields = authFields.concat(baseAuthFields)\n\n      if (sanitized.auth.verify) {\n        if (sanitized.auth.verify === true) sanitized.auth.verify = {}\n        authFields = authFields.concat(baseVerificationFields)\n      }\n\n      if (sanitized.auth.maxLoginAttempts > 0) {\n        authFields = authFields.concat(baseAccountLockFields)\n      }\n    }\n\n    // disable duplicate for auth enabled collections by default\n    sanitized.disableDuplicate = sanitized.disableDuplicate || true\n\n    if (!sanitized.auth.strategies) {\n      sanitized.auth.strategies = []\n    }\n\n    sanitized.fields = mergeBaseFields(sanitized.fields, authFields)\n  }\n\n  // /////////////////////////////////\n  // Sanitize fields\n  // /////////////////////////////////\n\n  const validRelationships = config.collections.map((c) => c.slug) || []\n  sanitized.fields = await sanitizeFields({\n    config,\n    fields: sanitized.fields,\n    richTextSanitizationPromises,\n    validRelationships,\n  })\n\n  return sanitized as SanitizedCollectionConfig\n}\n"],"names":["merge","baseAccountLockFields","baseAPIKeyFields","baseAuthFields","baseVerificationFields","TimestampsRequired","sanitizeFields","fieldAffectsData","mergeBaseFields","getBaseUploadFields","formatLabels","isPlainObject","baseVersionFields","versionDefaults","authDefaults","defaults","sanitizeCollection","config","collection","richTextSanitizationPromises","sanitized","isMergeableObject","timestamps","hasUpdatedAt","hasCreatedAt","fields","some","field","name","push","type","admin","disableBulkEdit","hidden","label","t","index","labels","slug","versions","drafts","autosave","validate","interval","autosaveInterval","undefined","upload","disableDuplicate","staticDir","useAsTitle","uploadFields","auth","authFields","useAPIKey","concat","disableLocalStrategy","verify","maxLoginAttempts","strategies","validRelationships","collections","map","c"],"mappings":"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"}