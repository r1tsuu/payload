{"version":3,"sources":["../../../src/collections/operations/docAccess.ts"],"sourcesContent":["import type { CollectionPermission } from '../../auth/index.js'\nimport type { AllOperations, PayloadRequestWithData } from '../../types/index.js'\nimport type { Collection } from '../config/types.js'\n\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { getEntityPolicies } from '../../utilities/getEntityPolicies.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\n\nconst allOperations: AllOperations[] = ['create', 'read', 'update', 'delete']\n\ntype Arguments = {\n  collection: Collection\n  id: string\n  req: PayloadRequestWithData\n}\n\nexport async function docAccessOperation(args: Arguments): Promise<CollectionPermission> {\n  const {\n    id,\n    collection: { config },\n    req,\n  } = args\n\n  const collectionOperations = [...allOperations]\n\n  if (\n    config.auth &&\n    typeof config.auth.maxLoginAttempts !== 'undefined' &&\n    config.auth.maxLoginAttempts !== 0\n  ) {\n    collectionOperations.push('unlock')\n  }\n\n  if (config.versions) {\n    collectionOperations.push('readVersions')\n  }\n\n  try {\n    const shouldCommit = await initTransaction(req)\n\n    const result = await getEntityPolicies({\n      id,\n      type: 'collection',\n      entity: config,\n      operations: collectionOperations,\n      req,\n    })\n\n    if (shouldCommit) await commitTransaction(req)\n\n    return result\n  } catch (e: unknown) {\n    await killTransaction(req)\n    throw e\n  }\n}\n"],"names":["commitTransaction","getEntityPolicies","initTransaction","killTransaction","allOperations","docAccessOperation","args","id","collection","config","req","collectionOperations","auth","maxLoginAttempts","push","versions","shouldCommit","result","type","entity","operations","e"],"mappings":"AAIA,SAASA,iBAAiB,QAAQ,uCAAsC;AACxE,SAASC,iBAAiB,QAAQ,uCAAsC;AACxE,SAASC,eAAe,QAAQ,qCAAoC;AACpE,SAASC,eAAe,QAAQ,qCAAoC;AAEpE,MAAMC,gBAAiC;IAAC;IAAU;IAAQ;IAAU;CAAS;AAQ7E,OAAO,eAAeC,mBAAmBC,IAAe;IACtD,MAAM,EACJC,EAAE,EACFC,YAAY,EAAEC,MAAM,EAAE,EACtBC,GAAG,EACJ,GAAGJ;IAEJ,MAAMK,uBAAuB;WAAIP;KAAc;IAE/C,IACEK,OAAOG,IAAI,IACX,OAAOH,OAAOG,IAAI,CAACC,gBAAgB,KAAK,eACxCJ,OAAOG,IAAI,CAACC,gBAAgB,KAAK,GACjC;QACAF,qBAAqBG,IAAI,CAAC;IAC5B;IAEA,IAAIL,OAAOM,QAAQ,EAAE;QACnBJ,qBAAqBG,IAAI,CAAC;IAC5B;IAEA,IAAI;QACF,MAAME,eAAe,MAAMd,gBAAgBQ;QAE3C,MAAMO,SAAS,MAAMhB,kBAAkB;YACrCM;YACAW,MAAM;YACNC,QAAQV;YACRW,YAAYT;YACZD;QACF;QAEA,IAAIM,cAAc,MAAMhB,kBAAkBU;QAE1C,OAAOO;IACT,EAAE,OAAOI,GAAY;QACnB,MAAMlB,gBAAgBO;QACtB,MAAMW;IACR;AACF"}