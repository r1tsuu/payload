{"version":3,"sources":["../../src/find/traverseFields.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\nimport type { Field } from 'payload'\n\nimport { fieldAffectsData, tabHasName } from 'payload/shared'\nimport toSnakeCase from 'to-snake-case'\n\nimport type { PostgresAdapter } from '../types.js'\nimport type { Result } from './buildFindManyArgs.js'\n\ntype TraverseFieldArgs = {\n  _locales: Result\n  adapter: PostgresAdapter\n  currentArgs: Result\n  currentTableName: string\n  depth?: number\n  fields: Field[]\n  path: string\n  topLevelArgs: Record<string, unknown>\n  topLevelTableName: string\n}\n\nexport const traverseFields = ({\n  _locales,\n  adapter,\n  currentArgs,\n  currentTableName,\n  depth,\n  fields,\n  path,\n  topLevelArgs,\n  topLevelTableName,\n}: TraverseFieldArgs) => {\n  fields.forEach((field) => {\n    if ('dbStore' in field && !field.dbStore) return\n\n    // handle simple relationship\n    if (\n      depth > 0 &&\n      (field.type === 'upload' ||\n        (field.type === 'relationship' && !field.hasMany && typeof field.relationTo === 'string'))\n    ) {\n      if (field.localized) {\n        _locales.with[`${path}${field.name}`] = true\n      } else {\n        currentArgs.with[`${path}${field.name}`] = true\n      }\n    }\n\n    if (field.type === 'collapsible' || field.type === 'row') {\n      traverseFields({\n        _locales,\n        adapter,\n        currentArgs,\n        currentTableName,\n        depth,\n        fields: field.fields,\n        path,\n        topLevelArgs,\n        topLevelTableName,\n      })\n\n      return\n    }\n\n    if (field.type === 'tabs') {\n      field.tabs.forEach((tab) => {\n        const tabPath = tabHasName(tab) ? `${path}${tab.name}_` : path\n\n        traverseFields({\n          _locales,\n          adapter,\n          currentArgs,\n          currentTableName,\n          depth,\n          fields: tab.fields,\n          path: tabPath,\n          topLevelArgs,\n          topLevelTableName,\n        })\n      })\n\n      return\n    }\n\n    if (fieldAffectsData(field)) {\n      switch (field.type) {\n        case 'array': {\n          if (field.dbJsonColumn) break\n          const withArray: Result = {\n            columns: {\n              _parentID: false,\n            },\n            orderBy: ({ _order }, { asc }) => [asc(_order)],\n            with: {},\n          }\n\n          const arrayTableName = adapter.tableNameMap.get(\n            `${currentTableName}_${path}${toSnakeCase(field.name)}`,\n          )\n\n          const arrayTableNameWithLocales = `${arrayTableName}${adapter.localesSuffix}`\n\n          if (adapter.tables[arrayTableNameWithLocales]) {\n            withArray.with._locales = {\n              columns: {\n                id: false,\n                _parentID: false,\n              },\n              with: {},\n            }\n          }\n          currentArgs.with[`${path}${field.name}`] = withArray\n\n          traverseFields({\n            _locales: withArray.with._locales,\n            adapter,\n            currentArgs: withArray,\n            currentTableName: arrayTableName,\n            depth,\n            fields: field.fields,\n            path: '',\n            topLevelArgs,\n            topLevelTableName,\n          })\n\n          break\n        }\n\n        case 'select': {\n          if (field.dbJsonColumn) break\n          if (field.hasMany) {\n            const withSelect: Result = {\n              columns: {\n                id: false,\n                order: false,\n                parent: false,\n              },\n              orderBy: ({ order }, { asc }) => [asc(order)],\n            }\n\n            currentArgs.with[`${path}${field.name}`] = withSelect\n          }\n\n          break\n        }\n\n        case 'blocks':\n          if (field.dbJsonColumn) break\n          field.blocks.forEach((block) => {\n            const blockKey = `_blocks_${block.slug}`\n\n            if (!topLevelArgs[blockKey]) {\n              const withBlock: Result = {\n                columns: {\n                  _parentID: false,\n                },\n                orderBy: ({ _order }, { asc }) => [asc(_order)],\n                with: {},\n              }\n\n              const tableName = adapter.tableNameMap.get(\n                `${topLevelTableName}_blocks_${toSnakeCase(block.slug)}`,\n              )\n\n              if (adapter.tables[`${tableName}${adapter.localesSuffix}`]) {\n                withBlock.with._locales = {\n                  with: {},\n                }\n              }\n              topLevelArgs.with[blockKey] = withBlock\n\n              traverseFields({\n                _locales: withBlock.with._locales,\n                adapter,\n                currentArgs: withBlock,\n                currentTableName: tableName,\n                depth,\n                fields: block.fields,\n                path: '',\n                topLevelArgs,\n                topLevelTableName,\n              })\n            }\n          })\n\n          break\n\n        case 'group':\n          if (field.dbJsonColumn) break\n          traverseFields({\n            _locales,\n            adapter,\n            currentArgs,\n            currentTableName,\n            depth,\n            fields: field.fields,\n            path: `${path}${field.name}_`,\n            topLevelArgs,\n            topLevelTableName,\n          })\n\n          break\n\n        default: {\n          break\n        }\n      }\n    }\n  })\n\n  return topLevelArgs\n}\n"],"names":["fieldAffectsData","tabHasName","toSnakeCase","traverseFields","_locales","adapter","currentArgs","currentTableName","depth","fields","path","topLevelArgs","topLevelTableName","forEach","field","dbStore","type","hasMany","relationTo","localized","with","name","tabs","tab","tabPath","dbJsonColumn","withArray","columns","_parentID","orderBy","_order","asc","arrayTableName","tableNameMap","get","arrayTableNameWithLocales","localesSuffix","tables","id","withSelect","order","parent","blocks","block","blockKey","slug","withBlock","tableName"],"mappings":"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"}