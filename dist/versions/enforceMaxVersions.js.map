{"version":3,"sources":["../../src/versions/enforceMaxVersions.ts"],"sourcesContent":["import type { SanitizedCollectionConfig } from '../collections/config/types.js'\nimport type { SanitizedGlobalConfig } from '../globals/config/types.js'\nimport type { Payload, PayloadRequestWithData, Where } from '../types/index.js'\n\ntype Args = {\n  collection?: SanitizedCollectionConfig\n  global?: SanitizedGlobalConfig\n  id?: number | string\n  max: number\n  payload: Payload\n  req?: PayloadRequestWithData\n}\n\nexport const enforceMaxVersions = async ({\n  id,\n  collection,\n  global,\n  max,\n  payload,\n  req,\n}: Args): Promise<void> => {\n  const entityType = collection ? 'collection' : 'global'\n  const slug = collection ? collection.slug : global?.slug\n\n  try {\n    const where: Where = {}\n    let oldestAllowedDoc\n\n    if (collection) {\n      where.parent = {\n        equals: id,\n      }\n\n      const query = await payload.db.findVersions({\n        collection: collection.slug,\n        pagination: false,\n        req,\n        skip: max,\n        sort: '-updatedAt',\n        where,\n      })\n\n      ;[oldestAllowedDoc] = query.docs\n    } else if (global) {\n      const query = await payload.db.findGlobalVersions({\n        global: global.slug,\n        pagination: false,\n        req,\n        skip: max,\n        sort: '-updatedAt',\n        where,\n      })\n\n      ;[oldestAllowedDoc] = query.docs\n    }\n\n    if (oldestAllowedDoc?.updatedAt) {\n      const deleteQuery: Where = {\n        updatedAt: {\n          less_than_equal: oldestAllowedDoc.updatedAt,\n        },\n      }\n\n      if (collection) {\n        deleteQuery.parent = {\n          equals: id,\n        }\n      }\n\n      await payload.db.deleteVersions({\n        collection: slug,\n        req,\n        where: deleteQuery,\n      })\n    }\n  } catch (err) {\n    payload.logger.error(\n      `There was an error cleaning up old versions for the ${entityType} ${slug}`,\n    )\n  }\n}\n"],"names":["enforceMaxVersions","id","collection","global","max","payload","req","entityType","slug","where","oldestAllowedDoc","parent","equals","query","db","findVersions","pagination","skip","sort","docs","findGlobalVersions","updatedAt","deleteQuery","less_than_equal","deleteVersions","err","logger","error"],"mappings":"AAaA,OAAO,MAAMA,qBAAqB,OAAO,EACvCC,EAAE,EACFC,UAAU,EACVC,MAAM,EACNC,GAAG,EACHC,OAAO,EACPC,GAAG,EACE;IACL,MAAMC,aAAaL,aAAa,eAAe;IAC/C,MAAMM,OAAON,aAAaA,WAAWM,IAAI,GAAGL,QAAQK;IAEpD,IAAI;QACF,MAAMC,QAAe,CAAC;QACtB,IAAIC;QAEJ,IAAIR,YAAY;YACdO,MAAME,MAAM,GAAG;gBACbC,QAAQX;YACV;YAEA,MAAMY,QAAQ,MAAMR,QAAQS,EAAE,CAACC,YAAY,CAAC;gBAC1Cb,YAAYA,WAAWM,IAAI;gBAC3BQ,YAAY;gBACZV;gBACAW,MAAMb;gBACNc,MAAM;gBACNT;YACF;YAEC,CAACC,iBAAiB,GAAGG,MAAMM,IAAI;QAClC,OAAO,IAAIhB,QAAQ;YACjB,MAAMU,QAAQ,MAAMR,QAAQS,EAAE,CAACM,kBAAkB,CAAC;gBAChDjB,QAAQA,OAAOK,IAAI;gBACnBQ,YAAY;gBACZV;gBACAW,MAAMb;gBACNc,MAAM;gBACNT;YACF;YAEC,CAACC,iBAAiB,GAAGG,MAAMM,IAAI;QAClC;QAEA,IAAIT,kBAAkBW,WAAW;YAC/B,MAAMC,cAAqB;gBACzBD,WAAW;oBACTE,iBAAiBb,iBAAiBW,SAAS;gBAC7C;YACF;YAEA,IAAInB,YAAY;gBACdoB,YAAYX,MAAM,GAAG;oBACnBC,QAAQX;gBACV;YACF;YAEA,MAAMI,QAAQS,EAAE,CAACU,cAAc,CAAC;gBAC9BtB,YAAYM;gBACZF;gBACAG,OAAOa;YACT;QACF;IACF,EAAE,OAAOG,KAAK;QACZpB,QAAQqB,MAAM,CAACC,KAAK,CAClB,CAAC,oDAAoD,EAAEpB,WAAW,CAAC,EAAEC,KAAK,CAAC;IAE/E;AACF,EAAC"}