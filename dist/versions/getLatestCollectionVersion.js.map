{"version":3,"sources":["../../src/versions/getLatestCollectionVersion.ts"],"sourcesContent":["import type { SanitizedCollectionConfig, TypeWithID } from '../collections/config/types.js'\nimport type { FindOneArgs } from '../database/types.js'\nimport type { Payload, PayloadRequestWithData } from '../types/index.js'\nimport type { TypeWithVersion } from './types.js'\n\nimport { docHasTimestamps } from '../types/index.js'\n\ntype Args = {\n  config: SanitizedCollectionConfig\n  id: number | string\n  payload: Payload\n  query: FindOneArgs\n  req?: PayloadRequestWithData\n}\n\nexport const getLatestCollectionVersion = async <T extends TypeWithID = any>({\n  id,\n  config,\n  payload,\n  query,\n  req,\n}: Args): Promise<T> => {\n  let latestVersion: TypeWithVersion<T>\n\n  if (config.versions?.drafts) {\n    const { docs } = await payload.db.findVersions<T>({\n      collection: config.slug,\n      limit: 1,\n      pagination: false,\n      req,\n      sort: '-updatedAt',\n      where: { parent: { equals: id } },\n    })\n    ;[latestVersion] = docs\n  }\n\n  const doc = await payload.db.findOne<T>({ ...query, req })\n\n  if (!latestVersion || (docHasTimestamps(doc) && latestVersion.updatedAt < doc.updatedAt)) {\n    return doc\n  }\n\n  return {\n    ...latestVersion.version,\n    id,\n    createdAt: latestVersion.createdAt,\n    updatedAt: latestVersion.updatedAt,\n  }\n}\n"],"names":["docHasTimestamps","getLatestCollectionVersion","id","config","payload","query","req","latestVersion","versions","drafts","docs","db","findVersions","collection","slug","limit","pagination","sort","where","parent","equals","doc","findOne","updatedAt","version","createdAt"],"mappings":"AAKA,SAASA,gBAAgB,QAAQ,oBAAmB;AAUpD,OAAO,MAAMC,6BAA6B,OAAmC,EAC3EC,EAAE,EACFC,MAAM,EACNC,OAAO,EACPC,KAAK,EACLC,GAAG,EACE;IACL,IAAIC;IAEJ,IAAIJ,OAAOK,QAAQ,EAAEC,QAAQ;QAC3B,MAAM,EAAEC,IAAI,EAAE,GAAG,MAAMN,QAAQO,EAAE,CAACC,YAAY,CAAI;YAChDC,YAAYV,OAAOW,IAAI;YACvBC,OAAO;YACPC,YAAY;YACZV;YACAW,MAAM;YACNC,OAAO;gBAAEC,QAAQ;oBAAEC,QAAQlB;gBAAG;YAAE;QAClC;QACC,CAACK,cAAc,GAAGG;IACrB;IAEA,MAAMW,MAAM,MAAMjB,QAAQO,EAAE,CAACW,OAAO,CAAI;QAAE,GAAGjB,KAAK;QAAEC;IAAI;IAExD,IAAI,CAACC,iBAAkBP,iBAAiBqB,QAAQd,cAAcgB,SAAS,GAAGF,IAAIE,SAAS,EAAG;QACxF,OAAOF;IACT;IAEA,OAAO;QACL,GAAGd,cAAciB,OAAO;QACxBtB;QACAuB,WAAWlB,cAAckB,SAAS;QAClCF,WAAWhB,cAAcgB,SAAS;IACpC;AACF,EAAC"}