{"version":3,"sources":["../../src/config/validate.ts"],"sourcesContent":["import type { ValidationResult } from 'joi'\nimport type { Logger } from 'pino'\n\nimport type { SanitizedCollectionConfig } from '../collections/config/types.js'\nimport type { SanitizedGlobalConfig } from '../globals/config/types.js'\nimport type { SanitizedConfig } from './types.js'\n\nimport collectionSchema from '../collections/config/schema.js'\nimport fieldSchema, { idField } from '../fields/config/schema.js'\nimport { fieldAffectsData } from '../fields/config/types.js'\nimport globalSchema from '../globals/config/schema.js'\nimport schema from './schema.js'\n\nconst validateFields = (\n  context: string,\n  entity: SanitizedCollectionConfig | SanitizedGlobalConfig,\n): string[] => {\n  const errors: string[] = []\n  entity.fields.forEach((field) => {\n    let idResult: Partial<ValidationResult> = { error: null }\n    if (fieldAffectsData(field) && field.name === 'id') {\n      idResult = idField.validate(field, { abortEarly: false })\n    }\n\n    const result = fieldSchema.validate(field, { abortEarly: false })\n    if (idResult.error) {\n      idResult.error.details.forEach(({ message }) => {\n        errors.push(\n          `${context} \"${entity.slug}\" > Field${\n            fieldAffectsData(field) ? ` \"${field.name}\" >` : ''\n          } ${message}`,\n        )\n      })\n    }\n    if (result.error) {\n      result.error.details.forEach(({ message }) => {\n        errors.push(\n          `${context} \"${entity.slug}\" > Field${\n            fieldAffectsData(field) ? ` \"${field.name}\" >` : ''\n          } ${message}`,\n        )\n      })\n    }\n  })\n  return errors\n}\n\nconst validateCollections = (collections: SanitizedCollectionConfig[]): string[] => {\n  const errors: string[] = []\n  collections.forEach((collection) => {\n    const result = collectionSchema.validate(collection, { abortEarly: false })\n    if (result.error) {\n      result.error.details.forEach(({ message }) => {\n        errors.push(`Collection \"${collection.slug}\" > ${message}`)\n      })\n    }\n    errors.push(...validateFields('Collection', collection))\n  })\n\n  return errors\n}\n\nconst validateGlobals = (globals: SanitizedGlobalConfig[]): string[] => {\n  const errors: string[] = []\n  globals.forEach((global) => {\n    const result = globalSchema.validate(global, { abortEarly: false })\n    if (result.error) {\n      result.error.details.forEach(({ message }) => {\n        errors.push(`Globals \"${global.slug}\" > ${message}`)\n      })\n    }\n    errors.push(...validateFields('Global', global))\n  })\n\n  return errors\n}\n\nexport const validateSchema = (config: SanitizedConfig, logger: Logger): SanitizedConfig => {\n  const result = schema.validate(config, {\n    abortEarly: false,\n  })\n\n  const nestedErrors = [\n    ...validateCollections(config.collections),\n    ...validateGlobals(config.globals),\n  ]\n\n  if (result.error || nestedErrors.length > 0) {\n    logger.error(\n      `There were ${\n        (result.error?.details?.length || 0) + nestedErrors.length\n      } errors validating your Payload config`,\n    )\n\n    let i = 0\n    if (result.error) {\n      result.error.details.forEach(({ message }) => {\n        i += 1\n        logger.error(`${i}: ${message}`)\n      })\n    }\n    nestedErrors.forEach((message) => {\n      i += 1\n      logger.error(`${i}: ${message}`)\n    })\n\n    process.exit(1)\n  }\n\n  return result.value\n}\n"],"names":["collectionSchema","fieldSchema","idField","fieldAffectsData","globalSchema","schema","validateFields","context","entity","errors","fields","forEach","field","idResult","error","name","validate","abortEarly","result","details","message","push","slug","validateCollections","collections","collection","validateGlobals","globals","global","validateSchema","config","logger","nestedErrors","length","i","process","exit","value"],"mappings":"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"}