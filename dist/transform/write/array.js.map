{"version":3,"sources":["../../../src/transform/write/array.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\nimport type { ArrayField } from 'payload'\n\nimport type { PostgresAdapter } from '../../types.js'\nimport type { ArrayRowToInsert, BlockRowToInsert, RelationshipToDelete } from './types.js'\n\nimport { isArrayOfRows } from '../../utilities/isArrayOfRows.js'\nimport { traverseFields } from './traverseFields.js'\n\ntype Args = {\n  adapter: PostgresAdapter\n  arrayTableName: string\n  baseTableName: string\n  blocks: {\n    [blockType: string]: BlockRowToInsert[]\n  }\n  blocksToDelete: Set<string>\n  data: unknown\n  field: ArrayField\n  locale?: string\n  numbers: Record<string, unknown>[]\n  path: string\n  relationships: Record<string, unknown>[]\n  relationshipsToDelete: RelationshipToDelete[]\n  selects: {\n    [tableName: string]: Record<string, unknown>[]\n  }\n  texts: Record<string, unknown>[]\n}\n\nexport const transformArray = ({\n  adapter,\n  arrayTableName,\n  baseTableName,\n  blocks,\n  blocksToDelete,\n  data,\n  field,\n  locale,\n  numbers,\n  path,\n  relationships,\n  relationshipsToDelete,\n  selects,\n  texts,\n}: Args) => {\n  const newRows: ArrayRowToInsert[] = []\n\n  const hasUUID = adapter.tables[arrayTableName]._uuid\n\n  if (isArrayOfRows(data)) {\n    data.forEach((arrayRow, i) => {\n      const newRow: ArrayRowToInsert = {\n        arrays: {},\n        locales: {},\n        row: {\n          _order: i + 1,\n        },\n      }\n\n      // If we have declared a _uuid field on arrays,\n      // that means the ID has to be unique,\n      // and our ids within arrays are not unique.\n      // So move the ID to a uuid field for storage\n      // and allow the database to generate a serial id automatically\n      if (hasUUID) {\n        newRow.row._uuid = arrayRow.id\n        delete arrayRow.id\n      }\n\n      if (locale) {\n        newRow.locales[locale] = {\n          _locale: locale,\n        }\n      }\n\n      if (field.localized) {\n        newRow.row._locale = locale\n      }\n\n      traverseFields({\n        adapter,\n        arrays: newRow.arrays,\n        baseTableName,\n        blocks,\n        blocksToDelete,\n        columnPrefix: '',\n        data: arrayRow,\n        fieldPrefix: '',\n        fields: field.fields,\n        locales: newRow.locales,\n        numbers,\n        parentTableName: arrayTableName,\n        path: `${path || ''}${field.name}.${i}.`,\n        relationships,\n        relationshipsToDelete,\n        row: newRow.row,\n        selects,\n        texts,\n      })\n\n      newRows.push(newRow)\n    })\n  }\n\n  return newRows\n}\n"],"names":["isArrayOfRows","traverseFields","transformArray","adapter","arrayTableName","baseTableName","blocks","blocksToDelete","data","field","locale","numbers","path","relationships","relationshipsToDelete","selects","texts","newRows","hasUUID","tables","_uuid","forEach","arrayRow","i","newRow","arrays","locales","row","_order","id","_locale","localized","columnPrefix","fieldPrefix","fields","parentTableName","name","push"],"mappings":"AAAA,oCAAoC,GAMpC,SAASA,aAAa,QAAQ,mCAAkC;AAChE,SAASC,cAAc,QAAQ,sBAAqB;AAuBpD,OAAO,MAAMC,iBAAiB,CAAC,EAC7BC,OAAO,EACPC,cAAc,EACdC,aAAa,EACbC,MAAM,EACNC,cAAc,EACdC,IAAI,EACJC,KAAK,EACLC,MAAM,EACNC,OAAO,EACPC,IAAI,EACJC,aAAa,EACbC,qBAAqB,EACrBC,OAAO,EACPC,KAAK,EACA;IACL,MAAMC,UAA8B,EAAE;IAEtC,MAAMC,UAAUf,QAAQgB,MAAM,CAACf,eAAe,CAACgB,KAAK;IAEpD,IAAIpB,cAAcQ,OAAO;QACvBA,KAAKa,OAAO,CAAC,CAACC,UAAUC;YACtB,MAAMC,SAA2B;gBAC/BC,QAAQ,CAAC;gBACTC,SAAS,CAAC;gBACVC,KAAK;oBACHC,QAAQL,IAAI;gBACd;YACF;YAEA,+CAA+C;YAC/C,sCAAsC;YACtC,4CAA4C;YAC5C,6CAA6C;YAC7C,+DAA+D;YAC/D,IAAIL,SAAS;gBACXM,OAAOG,GAAG,CAACP,KAAK,GAAGE,SAASO,EAAE;gBAC9B,OAAOP,SAASO,EAAE;YACpB;YAEA,IAAInB,QAAQ;gBACVc,OAAOE,OAAO,CAAChB,OAAO,GAAG;oBACvBoB,SAASpB;gBACX;YACF;YAEA,IAAID,MAAMsB,SAAS,EAAE;gBACnBP,OAAOG,GAAG,CAACG,OAAO,GAAGpB;YACvB;YAEAT,eAAe;gBACbE;gBACAsB,QAAQD,OAAOC,MAAM;gBACrBpB;gBACAC;gBACAC;gBACAyB,cAAc;gBACdxB,MAAMc;gBACNW,aAAa;gBACbC,QAAQzB,MAAMyB,MAAM;gBACpBR,SAASF,OAAOE,OAAO;gBACvBf;gBACAwB,iBAAiB/B;gBACjBQ,MAAM,CAAC,EAAEA,QAAQ,GAAG,EAAEH,MAAM2B,IAAI,CAAC,CAAC,EAAEb,EAAE,CAAC,CAAC;gBACxCV;gBACAC;gBACAa,KAAKH,OAAOG,GAAG;gBACfZ;gBACAC;YACF;YAEAC,QAAQoB,IAAI,CAACb;QACf;IACF;IAEA,OAAOP;AACT,EAAC"}