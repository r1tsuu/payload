{"version":3,"sources":["../../src/schema/traverseFields.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\nimport type { Relation } from 'drizzle-orm'\nimport type { IndexBuilder, PgColumnBuilder } from 'drizzle-orm/pg-core'\nimport type { Field, TabAsField } from 'payload'\n\nimport { relations } from 'drizzle-orm'\nimport {\n  PgNumericBuilder,\n  PgUUIDBuilder,\n  PgVarcharBuilder,\n  bigint,\n  boolean,\n  foreignKey,\n  index,\n  integer,\n  jsonb,\n  numeric,\n  pgEnum,\n  text,\n  timestamp,\n  varchar,\n} from 'drizzle-orm/pg-core'\nimport { InvalidConfiguration } from 'payload'\nimport { fieldAffectsData, optionIsObject } from 'payload/shared'\nimport toSnakeCase from 'to-snake-case'\n\nimport type { GenericColumns, IDType, PostgresAdapter } from '../types.js'\nimport type { BaseExtraConfig, RelationMap } from './build.js'\n\nimport { hasLocalesTable } from '../utilities/hasLocalesTable.js'\nimport { buildTable } from './build.js'\nimport { createIndex } from './createIndex.js'\nimport { createTableName } from './createTableName.js'\nimport { idToUUID } from './idToUUID.js'\nimport { numberColumnMap } from './numberColumnMap.js'\nimport { parentIDColumnMap } from './parentIDColumnMap.js'\nimport { validateExistingBlockIsIdentical } from './validateExistingBlockIsIdentical.js'\nimport { withDefault } from './withDefault.js'\n\ntype Args = {\n  adapter: PostgresAdapter\n  columnPrefix?: string\n  columns: Record<string, PgColumnBuilder>\n  disableNotNull: boolean\n  disableUnique?: boolean\n  fieldPrefix?: string\n  fields: (Field | TabAsField)[]\n  forceLocalized?: boolean\n  indexes: Record<string, (cols: GenericColumns) => IndexBuilder>\n  localesColumns: Record<string, PgColumnBuilder>\n  localesIndexes: Record<string, (cols: GenericColumns) => IndexBuilder>\n  newTableName: string\n  parentTableName: string\n  relationsToBuild: RelationMap\n  relationships: Set<string>\n  rootRelationsToBuild?: RelationMap\n  rootTableIDColType: string\n  rootTableName: string\n  versions: boolean\n}\n\ntype Result = {\n  hasLocalizedField: boolean\n  hasLocalizedManyNumberField: boolean\n  hasLocalizedManyTextField: boolean\n  hasLocalizedRelationshipField: boolean\n  hasManyNumberField: 'index' | boolean\n  hasManyTextField: 'index' | boolean\n}\n\nexport const traverseFields = ({\n  adapter,\n  columnPrefix,\n  columns,\n  disableNotNull,\n  disableUnique = false,\n  fieldPrefix,\n  fields,\n  forceLocalized,\n  indexes,\n  localesColumns,\n  localesIndexes,\n  newTableName,\n  parentTableName,\n  relationsToBuild,\n  relationships,\n  rootRelationsToBuild,\n  rootTableIDColType,\n  rootTableName,\n  versions,\n}: Args): Result => {\n  const throwValidationError = true\n  let hasLocalizedField = false\n  let hasLocalizedRelationshipField = false\n  let hasManyTextField: 'index' | boolean = false\n  let hasLocalizedManyTextField = false\n  let hasManyNumberField: 'index' | boolean = false\n  let hasLocalizedManyNumberField = false\n\n  let parentIDColType: IDType = 'integer'\n  if (columns.id instanceof PgUUIDBuilder) parentIDColType = 'uuid'\n  if (columns.id instanceof PgNumericBuilder) parentIDColType = 'numeric'\n  if (columns.id instanceof PgVarcharBuilder) parentIDColType = 'varchar'\n\n  fields.forEach((field) => {\n    if ('name' in field && field.name === 'id') return\n    let columnName: string\n    let fieldName: string\n\n    let targetTable = columns\n    let targetIndexes = indexes\n\n    if (fieldAffectsData(field)) {\n      if ('dbStore' in field) {\n        if (!field.dbStore) return\n      }\n\n      columnName = `${columnPrefix || ''}${field.name[0] === '_' ? '_' : ''}${toSnakeCase(\n        field.name,\n      )}`\n      fieldName = `${fieldPrefix?.replace('.', '_') || ''}${field.name}`\n\n      // If field is localized,\n      // add the column to the locale table instead of main table\n      if (\n        adapter.payload.config.localization &&\n        (field.localized || forceLocalized) &&\n        field.type !== 'array' &&\n        field.type !== 'blocks' &&\n        (('hasMany' in field && field.hasMany !== true) || !('hasMany' in field)) &&\n        (('dbJsonColumn' in field && field.dbJsonColumn !== true) || !('dbJsonColumn' in field))\n      ) {\n        hasLocalizedField = true\n        targetTable = localesColumns\n        targetIndexes = localesIndexes\n      }\n\n      if (\n        (field.unique || field.index) &&\n        !['array', 'blocks', 'group', 'point', 'relationship', 'upload'].includes(field.type) &&\n        !('hasMany' in field && field.hasMany === true)\n      ) {\n        const unique = disableUnique !== true && field.unique\n        if (unique) {\n          const constraintValue = `${fieldPrefix || ''}${field.name}`\n          if (!adapter.fieldConstraints?.[rootTableName]) {\n            adapter.fieldConstraints[rootTableName] = {}\n          }\n          adapter.fieldConstraints[rootTableName][`${columnName}_idx`] = constraintValue\n        }\n        targetIndexes[`${newTableName}_${field.name}Idx`] = createIndex({\n          name: fieldName,\n          columnName,\n          tableName: newTableName,\n          unique,\n        })\n      }\n    }\n\n    switch (field.type) {\n      case 'text': {\n        if (field.hasMany) {\n          if (field.dbJsonColumn) {\n            targetTable[fieldName] = withDefault(jsonb(columnName), field)\n            break\n          }\n\n          if (field.localized) {\n            hasLocalizedManyTextField = true\n          }\n\n          if (field.index) {\n            hasManyTextField = 'index'\n          } else if (!hasManyTextField) {\n            hasManyTextField = true\n          }\n\n          if (field.unique) {\n            throw new InvalidConfiguration(\n              'Unique is not supported in Postgres for hasMany text fields.',\n            )\n          }\n        } else {\n          targetTable[fieldName] = withDefault(varchar(columnName), field)\n        }\n        break\n      }\n      case 'email':\n      case 'code':\n      case 'textarea': {\n        targetTable[fieldName] = withDefault(varchar(columnName), field)\n        break\n      }\n\n      case 'number': {\n        if (field.hasMany) {\n          if (field.dbJsonColumn) {\n            targetTable[fieldName] = withDefault(jsonb(columnName), field)\n            break\n          }\n\n          if (field.localized) {\n            hasLocalizedManyNumberField = true\n          }\n\n          if (field.index) {\n            hasManyNumberField = 'index'\n          } else if (!hasManyNumberField) {\n            hasManyNumberField = true\n          }\n\n          if (field.unique) {\n            throw new InvalidConfiguration(\n              'Unique is not supported in Postgres for hasMany number fields.',\n            )\n          }\n        } else {\n          targetTable[fieldName] = withDefault(\n            numberColumnMap[field.dbType ?? 'numeric'](fieldName),\n            field,\n          )\n        }\n        break\n      }\n\n      case 'richText':\n      case 'json': {\n        targetTable[fieldName] = withDefault(jsonb(columnName), field)\n        break\n      }\n\n      case 'date': {\n        targetTable[fieldName] = withDefault(\n          timestamp(columnName, {\n            mode: 'string',\n            precision: 3,\n            withTimezone: true,\n          }),\n          field,\n        )\n        break\n      }\n\n      case 'point': {\n        break\n      }\n\n      case 'radio':\n      case 'select': {\n        if ('hasMany' in field && field.hasMany && field.dbJsonColumn) {\n          targetTable[fieldName] = withDefault(jsonb(fieldName), field)\n          break\n        }\n\n        const enumName = createTableName({\n          adapter,\n          config: field,\n          parentTableName: newTableName,\n          prefix: `enum_${newTableName}_`,\n          target: 'enumName',\n          throwValidationError,\n        })\n\n        adapter.enums[enumName] = pgEnum(\n          enumName,\n          field.options.map((option) => {\n            if (optionIsObject(option)) {\n              return option.value\n            }\n\n            return option\n          }) as [string, ...string[]],\n        )\n\n        if (field.type === 'select' && field.hasMany) {\n          const selectTableName = createTableName({\n            adapter,\n            config: field,\n            parentTableName: newTableName,\n            prefix: `${newTableName}_`,\n            throwValidationError,\n            versionsCustomName: versions,\n          })\n          const baseColumns: Record<string, PgColumnBuilder> = {\n            order: integer('order').notNull(),\n            parent: parentIDColumnMap[parentIDColType]('parent_id').notNull(),\n            value: adapter.enums[enumName]('value'),\n          }\n\n          const baseExtraConfig: BaseExtraConfig = {\n            orderIdx: (cols) => index(`${selectTableName}_order_idx`).on(cols.order),\n            parentFk: (cols) =>\n              foreignKey({\n                name: `${selectTableName}_parent_fk`,\n                columns: [cols.parent],\n                foreignColumns: [adapter.tables[parentTableName].id],\n              }).onDelete('cascade'),\n            parentIdx: (cols) => index(`${selectTableName}_parent_idx`).on(cols.parent),\n          }\n\n          if (field.localized) {\n            baseColumns.locale = adapter.enums.enum__locales('locale').notNull()\n            baseExtraConfig.localeIdx = (cols) =>\n              index(`${selectTableName}_locale_idx`).on(cols.locale)\n          }\n\n          if (field.index) {\n            baseExtraConfig.value = (cols) => index(`${selectTableName}_value_idx`).on(cols.value)\n          }\n\n          buildTable({\n            adapter,\n            baseColumns,\n            baseExtraConfig,\n            disableNotNull,\n            disableUnique,\n            fields: [],\n            rootTableName,\n            tableName: selectTableName,\n            versions,\n          })\n\n          relationsToBuild.set(fieldName, {\n            type: 'many',\n            // selects have their own localized table, independent of the base table.\n            localized: false,\n            target: selectTableName,\n          })\n\n          adapter.relations[`relations_${selectTableName}`] = relations(\n            adapter.tables[selectTableName],\n            ({ one }) => ({\n              parent: one(adapter.tables[parentTableName], {\n                fields: [adapter.tables[selectTableName].parent],\n                references: [adapter.tables[parentTableName].id],\n                relationName: fieldName,\n              }),\n            }),\n          )\n        } else {\n          targetTable[fieldName] = withDefault(adapter.enums[enumName](fieldName), field)\n        }\n        break\n      }\n\n      case 'checkbox': {\n        targetTable[fieldName] = withDefault(boolean(columnName), field)\n        break\n      }\n\n      case 'array': {\n        if (field.dbJsonColumn) {\n          targetTable[fieldName] = withDefault(jsonb(fieldName), field)\n          break\n        }\n\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        const arrayTableName = createTableName({\n          adapter,\n          config: field,\n          parentTableName: newTableName,\n          prefix: `${newTableName}_`,\n          throwValidationError,\n          versionsCustomName: versions,\n        })\n\n        const baseColumns: Record<string, PgColumnBuilder> = {\n          _order: integer('_order').notNull(),\n          _parentID: parentIDColumnMap[parentIDColType]('_parent_id').notNull(),\n        }\n\n        const baseExtraConfig: BaseExtraConfig = {\n          _orderIdx: (cols) => index(`${arrayTableName}_order_idx`).on(cols._order),\n          _parentIDFk: (cols) =>\n            foreignKey({\n              name: `${arrayTableName}_parent_id_fk`,\n              columns: [cols['_parentID']],\n              foreignColumns: [adapter.tables[parentTableName].id],\n            }).onDelete('cascade'),\n          _parentIDIdx: (cols) => index(`${arrayTableName}_parent_id_idx`).on(cols._parentID),\n        }\n\n        if (field.localized && adapter.payload.config.localization) {\n          baseColumns._locale = adapter.enums.enum__locales('_locale').notNull()\n          baseExtraConfig._localeIdx = (cols) =>\n            index(`${arrayTableName}_locale_idx`).on(cols._locale)\n        }\n\n        const {\n          hasManyNumberField: subHasManyNumberField,\n          hasManyTextField: subHasManyTextField,\n          relationsToBuild: subRelationsToBuild,\n        } = buildTable({\n          adapter,\n          baseColumns,\n          baseExtraConfig,\n          disableNotNull: disableNotNullFromHere,\n          disableUnique,\n          fields: disableUnique ? idToUUID(field.fields) : field.fields,\n          rootRelationsToBuild,\n          rootRelationships: relationships,\n          rootTableIDColType,\n          rootTableName,\n          tableName: arrayTableName,\n          versions,\n        })\n\n        if (subHasManyTextField) {\n          if (!hasManyTextField || subHasManyTextField === 'index')\n            hasManyTextField = subHasManyTextField\n        }\n        if (subHasManyNumberField) {\n          if (!hasManyNumberField || subHasManyNumberField === 'index')\n            hasManyNumberField = subHasManyNumberField\n        }\n\n        relationsToBuild.set(fieldName, {\n          type: 'many',\n          // arrays have their own localized table, independent of the base table.\n          localized: false,\n          target: arrayTableName,\n        })\n\n        adapter.relations[`relations_${arrayTableName}`] = relations(\n          adapter.tables[arrayTableName],\n          ({ many, one }) => {\n            const result: Record<string, Relation<string>> = {\n              _parentID: one(adapter.tables[parentTableName], {\n                fields: [adapter.tables[arrayTableName]._parentID],\n                references: [adapter.tables[parentTableName].id],\n                relationName: fieldName,\n              }),\n            }\n\n            if (hasLocalesTable(field.fields)) {\n              result._locales = many(adapter.tables[`${arrayTableName}${adapter.localesSuffix}`], {\n                relationName: '_locales',\n              })\n            }\n\n            subRelationsToBuild.forEach(({ type, localized, target }, key) => {\n              if (type === 'one') {\n                const arrayWithLocalized = localized\n                  ? `${arrayTableName}${adapter.localesSuffix}`\n                  : arrayTableName\n                result[key] = one(adapter.tables[target], {\n                  fields: [adapter.tables[arrayWithLocalized][key]],\n                  references: [adapter.tables[target].id],\n                  relationName: key,\n                })\n              }\n              if (type === 'many') {\n                result[key] = many(adapter.tables[target], { relationName: key })\n              }\n            })\n\n            return result\n          },\n        )\n\n        break\n      }\n\n      case 'blocks': {\n        if (field.dbJsonColumn) {\n          targetTable[fieldName] = withDefault(jsonb(fieldName), field)\n          break\n        }\n\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        field.blocks.forEach((block) => {\n          const blockTableName = createTableName({\n            adapter,\n            config: block,\n            parentTableName: rootTableName,\n            prefix: `${rootTableName}_blocks_`,\n            throwValidationError,\n            versionsCustomName: versions,\n          })\n          if (!adapter.tables[blockTableName]) {\n            const baseColumns: Record<string, PgColumnBuilder> = {\n              _order: integer('_order').notNull(),\n              _parentID: parentIDColumnMap[rootTableIDColType]('_parent_id').notNull(),\n              _path: text('_path').notNull(),\n            }\n\n            const baseExtraConfig: BaseExtraConfig = {\n              _orderIdx: (cols) => index(`${blockTableName}_order_idx`).on(cols._order),\n              _parentIDIdx: (cols) => index(`${blockTableName}_parent_id_idx`).on(cols._parentID),\n              _parentIdFk: (cols) =>\n                foreignKey({\n                  name: `${blockTableName}_parent_id_fk`,\n                  columns: [cols._parentID],\n                  foreignColumns: [adapter.tables[rootTableName].id],\n                }).onDelete('cascade'),\n              _pathIdx: (cols) => index(`${blockTableName}_path_idx`).on(cols._path),\n            }\n\n            if (field.localized && adapter.payload.config.localization) {\n              baseColumns._locale = adapter.enums.enum__locales('_locale').notNull()\n              baseExtraConfig._localeIdx = (cols) =>\n                index(`${blockTableName}_locale_idx`).on(cols._locale)\n            }\n\n            const {\n              hasManyNumberField: subHasManyNumberField,\n              hasManyTextField: subHasManyTextField,\n              relationsToBuild: subRelationsToBuild,\n            } = buildTable({\n              adapter,\n              baseColumns,\n              baseExtraConfig,\n              disableNotNull: disableNotNullFromHere,\n              disableUnique,\n              fields: disableUnique ? idToUUID(block.fields) : block.fields,\n              rootRelationsToBuild,\n              rootRelationships: relationships,\n              rootTableIDColType,\n              rootTableName,\n              tableName: blockTableName,\n              versions,\n            })\n\n            if (subHasManyTextField) {\n              if (!hasManyTextField || subHasManyTextField === 'index')\n                hasManyTextField = subHasManyTextField\n            }\n\n            if (subHasManyNumberField) {\n              if (!hasManyNumberField || subHasManyNumberField === 'index')\n                hasManyNumberField = subHasManyNumberField\n            }\n\n            adapter.relations[`relations_${blockTableName}`] = relations(\n              adapter.tables[blockTableName],\n              ({ many, one }) => {\n                const result: Record<string, Relation<string>> = {\n                  _parentID: one(adapter.tables[rootTableName], {\n                    fields: [adapter.tables[blockTableName]._parentID],\n                    references: [adapter.tables[rootTableName].id],\n                    relationName: `_blocks_${block.slug}`,\n                  }),\n                }\n\n                if (hasLocalesTable(block.fields)) {\n                  result._locales = many(\n                    adapter.tables[`${blockTableName}${adapter.localesSuffix}`],\n                    { relationName: '_locales' },\n                  )\n                }\n\n                subRelationsToBuild.forEach(({ type, localized, target }, key) => {\n                  if (type === 'one') {\n                    const blockWithLocalized = localized\n                      ? `${blockTableName}${adapter.localesSuffix}`\n                      : blockTableName\n                    result[key] = one(adapter.tables[target], {\n                      fields: [adapter.tables[blockWithLocalized][key]],\n                      references: [adapter.tables[target].id],\n                      relationName: key,\n                    })\n                  }\n                  if (type === 'many') {\n                    result[key] = many(adapter.tables[target], { relationName: key })\n                  }\n                })\n\n                return result\n              },\n            )\n          } else if (process.env.NODE_ENV !== 'production' && !versions) {\n            validateExistingBlockIsIdentical({\n              block,\n              localized: field.localized,\n              rootTableName,\n              table: adapter.tables[blockTableName],\n              tableLocales: adapter.tables[`${blockTableName}${adapter.localesSuffix}`],\n            })\n          }\n          // blocks relationships are defined from the collection or globals table down to the block, bypassing any subBlocks\n          rootRelationsToBuild.set(`_blocks_${block.slug}`, {\n            type: 'many',\n            // blocks are not localized on the parent table\n            localized: false,\n            target: blockTableName,\n          })\n        })\n\n        break\n      }\n\n      case 'tab':\n      case 'group': {\n        if (!('name' in field)) {\n          const {\n            hasLocalizedField: groupHasLocalizedField,\n            hasLocalizedManyNumberField: groupHasLocalizedManyNumberField,\n            hasLocalizedManyTextField: groupHasLocalizedManyTextField,\n            hasLocalizedRelationshipField: groupHasLocalizedRelationshipField,\n            hasManyNumberField: groupHasManyNumberField,\n            hasManyTextField: groupHasManyTextField,\n          } = traverseFields({\n            adapter,\n            columnPrefix,\n            columns,\n            disableNotNull,\n            disableUnique,\n            fieldPrefix,\n            fields: field.fields,\n            forceLocalized,\n            indexes,\n            localesColumns,\n            localesIndexes,\n            newTableName,\n            parentTableName,\n            relationsToBuild,\n            relationships,\n            rootRelationsToBuild,\n            rootTableIDColType,\n            rootTableName,\n            versions,\n          })\n\n          if (groupHasLocalizedField) hasLocalizedField = true\n          if (groupHasLocalizedRelationshipField) hasLocalizedRelationshipField = true\n          if (groupHasManyTextField) hasManyTextField = true\n          if (groupHasLocalizedManyTextField) hasLocalizedManyTextField = true\n          if (groupHasManyNumberField) hasManyNumberField = true\n          if (groupHasLocalizedManyNumberField) hasLocalizedManyNumberField = true\n          break\n        }\n\n        if (field.dbJsonColumn) {\n          if (field.dbJsonColumn) {\n            targetTable[fieldName] = withDefault(jsonb(fieldName), field)\n            break\n          }\n        }\n\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        const {\n          hasLocalizedField: groupHasLocalizedField,\n          hasLocalizedManyNumberField: groupHasLocalizedManyNumberField,\n          hasLocalizedManyTextField: groupHasLocalizedManyTextField,\n          hasLocalizedRelationshipField: groupHasLocalizedRelationshipField,\n          hasManyNumberField: groupHasManyNumberField,\n          hasManyTextField: groupHasManyTextField,\n        } = traverseFields({\n          adapter,\n          columnPrefix: `${columnName}_`,\n          columns,\n          disableNotNull: disableNotNullFromHere,\n          disableUnique,\n          fieldPrefix: `${fieldName}.`,\n          fields: field.fields,\n          forceLocalized: field.localized,\n          indexes,\n          localesColumns,\n          localesIndexes,\n          newTableName: `${parentTableName}_${columnName}`,\n          parentTableName,\n          relationsToBuild,\n          relationships,\n          rootRelationsToBuild,\n          rootTableIDColType,\n          rootTableName,\n          versions,\n        })\n\n        if (groupHasLocalizedField) hasLocalizedField = true\n        if (groupHasLocalizedRelationshipField) hasLocalizedRelationshipField = true\n        if (groupHasManyTextField) hasManyTextField = true\n        if (groupHasLocalizedManyTextField) hasLocalizedManyTextField = true\n        if (groupHasManyNumberField) hasManyNumberField = true\n        if (groupHasLocalizedManyNumberField) hasLocalizedManyNumberField = true\n        break\n      }\n\n      case 'tabs': {\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n\n        const {\n          hasLocalizedField: tabHasLocalizedField,\n          hasLocalizedManyNumberField: tabHasLocalizedManyNumberField,\n          hasLocalizedManyTextField: tabHasLocalizedManyTextField,\n          hasLocalizedRelationshipField: tabHasLocalizedRelationshipField,\n          hasManyNumberField: tabHasManyNumberField,\n          hasManyTextField: tabHasManyTextField,\n        } = traverseFields({\n          adapter,\n          columnPrefix,\n          columns,\n          disableNotNull: disableNotNullFromHere,\n          disableUnique,\n          fieldPrefix,\n          fields: field.tabs.map((tab) => ({ ...tab, type: 'tab' })),\n          forceLocalized,\n          indexes,\n          localesColumns,\n          localesIndexes,\n          newTableName,\n          parentTableName,\n          relationsToBuild,\n          relationships,\n          rootRelationsToBuild,\n          rootTableIDColType,\n          rootTableName,\n          versions,\n        })\n\n        if (tabHasLocalizedField) hasLocalizedField = true\n        if (tabHasLocalizedRelationshipField) hasLocalizedRelationshipField = true\n        if (tabHasManyTextField) hasManyTextField = true\n        if (tabHasLocalizedManyTextField) hasLocalizedManyTextField = true\n        if (tabHasManyNumberField) hasManyNumberField = true\n        if (tabHasLocalizedManyNumberField) hasLocalizedManyNumberField = true\n        break\n      }\n\n      case 'row':\n      case 'collapsible': {\n        const disableNotNullFromHere = Boolean(field.admin?.condition) || disableNotNull\n        const {\n          hasLocalizedField: rowHasLocalizedField,\n          hasLocalizedManyNumberField: rowHasLocalizedManyNumberField,\n          hasLocalizedManyTextField: rowHasLocalizedManyTextField,\n          hasLocalizedRelationshipField: rowHasLocalizedRelationshipField,\n          hasManyNumberField: rowHasManyNumberField,\n          hasManyTextField: rowHasManyTextField,\n        } = traverseFields({\n          adapter,\n          columnPrefix,\n          columns,\n          disableNotNull: disableNotNullFromHere,\n          disableUnique,\n          fieldPrefix,\n          fields: field.fields,\n          forceLocalized,\n          indexes,\n          localesColumns,\n          localesIndexes,\n          newTableName,\n          parentTableName,\n          relationsToBuild,\n          relationships,\n          rootRelationsToBuild,\n          rootTableIDColType,\n          rootTableName,\n          versions,\n        })\n\n        if (rowHasLocalizedField) hasLocalizedField = true\n        if (rowHasLocalizedRelationshipField) hasLocalizedRelationshipField = true\n        if (rowHasManyTextField) hasManyTextField = true\n        if (rowHasLocalizedManyTextField) hasLocalizedManyTextField = true\n        if (rowHasManyNumberField) hasManyNumberField = true\n        if (rowHasLocalizedManyNumberField) hasLocalizedManyNumberField = true\n        break\n      }\n\n      case 'relationship':\n      case 'upload':\n        if ('dbJsonColumn' in field && field.dbJsonColumn) {\n          targetTable[fieldName] = jsonb(fieldName)\n          break\n        }\n\n        if (Array.isArray(field.relationTo)) {\n          field.relationTo.forEach((relation) => relationships.add(relation))\n        } else if (field.type === 'relationship' && field.hasMany) {\n          relationships.add(field.relationTo)\n        } else {\n          // simple relationships get a column on the targetTable with a foreign key to the relationTo table\n          const relationshipConfig = adapter.payload.collections[field.relationTo].config\n\n          const tableName = adapter.tableNameMap.get(toSnakeCase(field.relationTo))\n\n          // get the id type of the related collection\n          let colType = adapter.idType === 'uuid' ? 'uuid' : 'integer'\n          const relatedCollectionCustomID = relationshipConfig.fields.find(\n            (field) => fieldAffectsData(field) && field.name === 'id',\n          )\n          if (relatedCollectionCustomID?.type === 'number') colType = 'numeric'\n          if (relatedCollectionCustomID?.type === 'text') colType = 'varchar'\n\n          // make the foreign key column for relationship using the correct id column type\n          targetTable[fieldName] = parentIDColumnMap[colType](`${columnName}_id`).references(\n            () => adapter.tables[tableName].id,\n            { onDelete: 'set null' },\n          )\n\n          // add relationship to table\n          relationsToBuild.set(fieldName, {\n            type: 'one',\n            localized: adapter.payload.config.localization && field.localized,\n            target: tableName,\n          })\n\n          // add notNull when not required\n          if (!disableNotNull && field.required && !field.admin?.condition) {\n            targetTable[fieldName].notNull()\n          }\n          break\n        }\n        if (adapter.payload.config.localization && field.localized) {\n          hasLocalizedRelationshipField = true\n        }\n\n        break\n\n      default:\n        break\n    }\n\n    const condition = field.admin && field.admin.condition\n\n    if (\n      !disableNotNull &&\n      targetTable[fieldName] &&\n      'required' in field &&\n      field.required &&\n      !condition\n    ) {\n      targetTable[fieldName].notNull()\n    }\n  })\n\n  return {\n    hasLocalizedField,\n    hasLocalizedManyNumberField,\n    hasLocalizedManyTextField,\n    hasLocalizedRelationshipField,\n    hasManyNumberField,\n    hasManyTextField,\n  }\n}\n"],"names":["relations","PgNumericBuilder","PgUUIDBuilder","PgVarcharBuilder","boolean","foreignKey","index","integer","jsonb","pgEnum","text","timestamp","varchar","InvalidConfiguration","fieldAffectsData","optionIsObject","toSnakeCase","hasLocalesTable","buildTable","createIndex","createTableName","idToUUID","numberColumnMap","parentIDColumnMap","validateExistingBlockIsIdentical","withDefault","traverseFields","adapter","columnPrefix","columns","disableNotNull","disableUnique","fieldPrefix","fields","forceLocalized","indexes","localesColumns","localesIndexes","newTableName","parentTableName","relationsToBuild","relationships","rootRelationsToBuild","rootTableIDColType","rootTableName","versions","throwValidationError","hasLocalizedField","hasLocalizedRelationshipField","hasManyTextField","hasLocalizedManyTextField","hasManyNumberField","hasLocalizedManyNumberField","parentIDColType","id","forEach","field","name","columnName","fieldName","targetTable","targetIndexes","dbStore","replace","payload","config","localization","localized","type","hasMany","dbJsonColumn","unique","includes","constraintValue","fieldConstraints","tableName","dbType","mode","precision","withTimezone","enumName","prefix","target","enums","options","map","option","value","selectTableName","versionsCustomName","baseColumns","order","notNull","parent","baseExtraConfig","orderIdx","cols","on","parentFk","foreignColumns","tables","onDelete","parentIdx","locale","enum__locales","localeIdx","set","one","references","relationName","disableNotNullFromHere","Boolean","admin","condition","arrayTableName","_order","_parentID","_orderIdx","_parentIDFk","_parentIDIdx","_locale","_localeIdx","subHasManyNumberField","subHasManyTextField","subRelationsToBuild","rootRelationships","many","result","_locales","localesSuffix","key","arrayWithLocalized","blocks","block","blockTableName","_path","_parentIdFk","_pathIdx","slug","blockWithLocalized","process","env","NODE_ENV","table","tableLocales","groupHasLocalizedField","groupHasLocalizedManyNumberField","groupHasLocalizedManyTextField","groupHasLocalizedRelationshipField","groupHasManyNumberField","groupHasManyTextField","tabHasLocalizedField","tabHasLocalizedManyNumberField","tabHasLocalizedManyTextField","tabHasLocalizedRelationshipField","tabHasManyNumberField","tabHasManyTextField","tabs","tab","rowHasLocalizedField","rowHasLocalizedManyNumberField","rowHasLocalizedManyTextField","rowHasLocalizedRelationshipField","rowHasManyNumberField","rowHasManyTextField","Array","isArray","relationTo","relation","add","relationshipConfig","collections","tableNameMap","get","colType","idType","relatedCollectionCustomID","find","required"],"mappings":"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"}