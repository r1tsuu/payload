{"version":3,"sources":["../../../../src/fields/hooks/afterRead/relationshipPopulationPromise.ts"],"sourcesContent":["import type { PayloadRequestWithData } from '../../../types/index.js'\nimport type { RelationshipField, UploadField } from '../../config/types.js'\n\nimport { createDataloaderCacheKey } from '../../../collections/dataloader.js'\nimport { fieldHasMaxDepth, fieldSupportsMany } from '../../config/types.js'\n\ntype PopulateArgs = {\n  currentDepth: number\n  data: Record<string, unknown>\n  dataReference: Record<string, any>\n  depth: number\n  draft: boolean\n  fallbackLocale: null | string\n  field: RelationshipField | UploadField\n  index?: number\n  key?: string\n  locale: null | string\n  overrideAccess: boolean\n  req: PayloadRequestWithData\n  showHiddenFields: boolean\n}\n\nconst populate = async ({\n  currentDepth,\n  data,\n  dataReference,\n  depth,\n  draft,\n  fallbackLocale,\n  field,\n  index,\n  key,\n  locale,\n  overrideAccess,\n  req,\n  showHiddenFields,\n}: PopulateArgs) => {\n  const dataToUpdate = dataReference\n  const relation = Array.isArray(field.relationTo) ? (data.relationTo as string) : field.relationTo\n  const relatedCollection = req.payload.collections[relation]\n\n  if (relatedCollection) {\n    let id = Array.isArray(field.relationTo) ? data.value : data\n    let relationshipValue\n    const shouldPopulate = depth && currentDepth <= depth\n\n    if (\n      typeof id !== 'string' &&\n      typeof id !== 'number' &&\n      typeof id?.toString === 'function' &&\n      typeof id !== 'object'\n    ) {\n      id = id.toString()\n    }\n\n    if (shouldPopulate) {\n      relationshipValue = await req.payloadDataLoader.load(\n        createDataloaderCacheKey({\n          collectionSlug: relatedCollection.config.slug,\n          currentDepth: currentDepth + 1,\n          depth,\n          docID: id as string,\n          draft,\n          fallbackLocale,\n          locale,\n          overrideAccess,\n          showHiddenFields,\n          transactionID: req.transactionID,\n        }),\n      )\n    }\n\n    if (!relationshipValue) {\n      // ids are visible regardless of access controls\n      relationshipValue = id\n    }\n\n    if (typeof index === 'number' && typeof key === 'string') {\n      if (Array.isArray(field.relationTo)) {\n        dataToUpdate[field.name][key][index].value = relationshipValue\n      } else {\n        dataToUpdate[field.name][key][index] = relationshipValue\n      }\n    } else if (typeof index === 'number' || typeof key === 'string') {\n      if (Array.isArray(field.relationTo)) {\n        dataToUpdate[field.name][index ?? key].value = relationshipValue\n      } else {\n        dataToUpdate[field.name][index ?? key] = relationshipValue\n      }\n    } else if (Array.isArray(field.relationTo)) {\n      dataToUpdate[field.name].value = relationshipValue\n    } else {\n      dataToUpdate[field.name] = relationshipValue\n    }\n  }\n}\n\ntype PromiseArgs = {\n  currentDepth: number\n  depth: number\n  draft: boolean\n  fallbackLocale: null | string\n  field: RelationshipField | UploadField\n  locale: null | string\n  overrideAccess: boolean\n  req: PayloadRequestWithData\n  showHiddenFields: boolean\n  siblingDoc: Record<string, any>\n}\n\nexport const relationshipPopulationPromise = async ({\n  currentDepth,\n  depth,\n  draft,\n  fallbackLocale,\n  field,\n  locale,\n  overrideAccess,\n  req,\n  showHiddenFields,\n  siblingDoc,\n}: PromiseArgs): Promise<void> => {\n  const resultingDoc = siblingDoc\n  const populateDepth = fieldHasMaxDepth(field) && field.maxDepth < depth ? field.maxDepth : depth\n  const rowPromises = []\n\n  if (fieldSupportsMany(field) && field.hasMany) {\n    if (\n      locale === 'all' &&\n      typeof siblingDoc[field.name] === 'object' &&\n      siblingDoc[field.name] !== null\n    ) {\n      Object.keys(siblingDoc[field.name]).forEach((key) => {\n        if (Array.isArray(siblingDoc[field.name][key])) {\n          siblingDoc[field.name][key].forEach((relatedDoc, index) => {\n            const rowPromise = async () => {\n              await populate({\n                currentDepth,\n                data: siblingDoc[field.name][key][index],\n                dataReference: resultingDoc,\n                depth: populateDepth,\n                draft,\n                fallbackLocale,\n                field,\n                index,\n                key,\n                locale,\n                overrideAccess,\n                req,\n                showHiddenFields,\n              })\n            }\n            rowPromises.push(rowPromise())\n          })\n        }\n      })\n    } else if (Array.isArray(siblingDoc[field.name])) {\n      siblingDoc[field.name].forEach((relatedDoc, index) => {\n        const rowPromise = async () => {\n          if (relatedDoc) {\n            await populate({\n              currentDepth,\n              data: relatedDoc,\n              dataReference: resultingDoc,\n              depth: populateDepth,\n              draft,\n              fallbackLocale,\n              field,\n              index,\n              locale,\n              overrideAccess,\n              req,\n              showHiddenFields,\n            })\n          }\n        }\n\n        rowPromises.push(rowPromise())\n      })\n    }\n  } else if (\n    typeof siblingDoc[field.name] === 'object' &&\n    siblingDoc[field.name] !== null &&\n    locale === 'all'\n  ) {\n    Object.keys(siblingDoc[field.name]).forEach((key) => {\n      const rowPromise = async () => {\n        await populate({\n          currentDepth,\n          data: siblingDoc[field.name][key],\n          dataReference: resultingDoc,\n          depth: populateDepth,\n          draft,\n          fallbackLocale,\n          field,\n          key,\n          locale,\n          overrideAccess,\n          req,\n          showHiddenFields,\n        })\n      }\n      rowPromises.push(rowPromise())\n    })\n\n    await Promise.all(rowPromises)\n  } else if (siblingDoc[field.name]) {\n    await populate({\n      currentDepth,\n      data: siblingDoc[field.name],\n      dataReference: resultingDoc,\n      depth: populateDepth,\n      draft,\n      fallbackLocale,\n      field,\n      locale,\n      overrideAccess,\n      req,\n      showHiddenFields,\n    })\n  }\n  await Promise.all(rowPromises)\n}\n"],"names":["createDataloaderCacheKey","fieldHasMaxDepth","fieldSupportsMany","populate","currentDepth","data","dataReference","depth","draft","fallbackLocale","field","index","key","locale","overrideAccess","req","showHiddenFields","dataToUpdate","relation","Array","isArray","relationTo","relatedCollection","payload","collections","id","value","relationshipValue","shouldPopulate","toString","payloadDataLoader","load","collectionSlug","config","slug","docID","transactionID","name","relationshipPopulationPromise","siblingDoc","resultingDoc","populateDepth","maxDepth","rowPromises","hasMany","Object","keys","forEach","relatedDoc","rowPromise","push","Promise","all"],"mappings":"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"}